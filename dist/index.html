
<!doctype html>

<html lang="ja">
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>Alexaスキル開発ハンズオン ～S3を繋げてAPL対応スキルを作ろう!～</title>
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://storage.googleapis.com/codelab-elements/codelab-elements.css">
  <style>
    .success {
      color: #1e8e3e;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <google-codelab-analytics gaid="UA-49880327-14"></google-codelab-analytics>
  <google-codelab codelab-gaid=""
                  id="dist"
                  title="Alexaスキル開発ハンズオン ～S3を繋げてAPL対応スキルを作ろう!～"
                  environment="web"
                  feedback-link="">
    
      <google-codelab-step label="プロジェクトを作成する" duration="1">
        <p>新規スキルのプロジェクトを作成します。こちらにアクセスしてください。<br><a href="https://developer.amazon.com/ja/alexa-skills-kit" target="_blank">https://developer.amazon.com/ja/alexa-skills-kit</a></p>
<h2>1-1. スキル開発を始めよう！</h2>
<p class="image-container">［スキル開発を始める］をクリックします。</p>
<p class="image-container"><img alt="s100" src="img/b271f296a74176d1.png"></p>
<p class="image-container">Amazonのアカウント情報を入力してログインします。</p>
<p class="image-container"><img alt="s101" src="img/2edc81633369d120.png"></p>
<p class="image-container">［スキルの作成］ボタンをクリックします。</p>
<p class="image-container"><img alt="s102" src="img/8533ffd0f4d85bf8.png"></p>
<p class="image-container">スキル名「メモスキル」を入力して、［カスタム］と［Alexaがホスト］をそれぞれ選択します。<br>最後に［スキルを作成］ボタンをクリックします。</p>
<p class="image-container"><img alt="s103" src="img/7f4eae6e08da59ca.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="スロットとインテントを作成しよう！" duration="6">
        <h2>2-1. スロットを作成する</h2>
<p class="image-container">メモをセーブとロードのスロットを作成します。左側メニューのスロットタイプにある［追加］ボタンをクリックします。</p>
<p class="image-container">「MemoSlot」と入力して［カスタムスロットタイプを作成］ボタンをクリックします。</p>
<p class="image-container"><img alt="s105" src="img/de790a037289952.png"></p>
<p class="image-container">「メモをセーブ」や「メモをロード」という言葉に反応させたいので、セーブとロードをそれぞれ登録します。同義語にそれ以外の言葉も登録しておきます。</p>
<p class="image-container"><img alt="s106" src="img/d8ceaeeebab8dfce.png"></p>
<h2>2-2. インテントを作成する</h2>
<p class="image-container">MainIntentを作成します。左側メニューのインテントにある［追加］ボタンをクリックします。</p>
<p class="image-container">「MainIntent」と入力して［カスタムインテントを作成］ボタンをクリックします。</p>
<p class="image-container"><img alt="s107" src="img/8b91e44ad351e7b6.png"></p>
<p class="image-container">インテントスロットを追加します。<code>any</code>と入力して［＋］をクリックします。プルダウンメニューから<code>AMAZON.SearchQuery</code>を選択します。［ダイアログを編集］リンクをクリックします。</p>
<p class="image-container"><img alt="s108" src="img/96a17cd296f3cecf.png"></p>
<p class="image-container">必須入力を有効化にします。Alexaの音声プロンプト部分に「メモする内容を言ってください。」と入力します。</p>
<p class="image-container">ユーザー発話部分は<code>{any}</code>と入力します。ユーザーが発話したらanyに格納されます。</p>
<p class="image-container"><img alt="s109" src="img/d718b8fadaaa7bb6.png"></p>
<p class="image-container">MainIntent部分をクリックして、元の画面に戻ります。</p>
<p class="image-container"><img alt="s110" src="img/557d78ea3db870f0.png"></p>
<p class="image-container">「オートデリゲートを無効化」をプルダウンメニューから選択します。</p>
<p class="image-container"><img alt="s111" src="img/e85fda01d5860de.png"></p>
<p class="image-container">「stat」と入力して［＋］をクリックします。プルダウンメニューは先程作成した<code>MemoSlot</code>を選択します。</p>
<p class="image-container"><img alt="s112" src="img/b8ad8b1b577ebdec.png"></p>
<p class="image-container">サンプル発話に考えられる文章を登録していきます。</p>
<p class="image-container">これで「メモをセーブ」や「メモをロード」という言葉に反応できるようになりました。</p>
<p class="image-container"><img alt="s113" src="img/807f2085ad2da65c.png"></p>
<p class="image-container">最後に必ず「保存」と「ビルド」を実行しておいてください。</p>
<p class="image-container"><img alt="s114" src="img/79c3fd94fb287e5.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="Alexa-hostedでスキルを作ろう" duration="6">
        <h2>3-1. S3にアクセスするプログラムを追加する</h2>
<p class="image-container">コードエディタタブをクリックします。左側にあるファイルから<code>package.json</code>を開きます。</p>
<p class="image-container">S3のnpm依存関係を追加します。</p>
<pre><code>&#34;ask-sdk-s3-persistence-adapter&#34;: &#34;^2.0.0&#34;
</code></pre>
<p class="image-container"><img alt="s115" src="img/a66c1eb28cae9887.png"></p>
<pre><code>{
  &#34;name&#34;: &#34;hello-world&#34;,
  &#34;version&#34;: &#34;0.9.0&#34;,
  &#34;description&#34;: &#34;alexa utility for quickly building skills&#34;,
  &#34;main&#34;: &#34;index.js&#34;,
  &#34;scripts&#34;: {
    &#34;test&#34;: &#34;echo \&#34;Error: no test specified\&#34; &amp;&amp; exit 1&#34;
  },
  &#34;author&#34;: &#34;Amazon Alexa&#34;,
  &#34;license&#34;: &#34;ISC&#34;,
  &#34;dependencies&#34;: {
    &#34;ask-sdk-core&#34;: &#34;^2.0.7&#34;,
    &#34;ask-sdk-model&#34;: &#34;^1.4.1&#34;,
    &#34;aws-sdk&#34;: &#34;^2.326.0&#34;,
    &#34;ask-sdk-s3-persistence-adapter&#34;: &#34;^2.0.0&#34;  // ←これを追加
  }
}
</code></pre>
<h2>3-2. index.jsファイルを編集する</h2>
<p class="image-container">プログラムの中身を編集します。<code>index.js</code>ファイルを開きます。</p>
<p class="image-container"><img alt="s116" src="img/dbb0f2745f2acdfe.png"></p>
<p>ファイルは下記からコピーしてください。<br><a href="https://raw.githubusercontent.com/gaomar/apl_handson_190323/master/files/step1.js" target="_blank">https://raw.githubusercontent.com/gaomar/apl_handson_190323/master/files/step1.js</a></p>
<pre><code>const Alexa = require(&#39;ask-sdk-core&#39;);

// 1. ask persistence adapterの読み込み
const persistenceAdapter = require(&#39;ask-sdk-s3-persistence-adapter&#39;);

// 2. スキルビルダーをアダプターを使用して初期化
const skillBuilder = Alexa.SkillBuilders.custom().withPersistenceAdapter(
    new persistenceAdapter.S3PersistenceAdapter({bucketName:process.env.S3_PERSISTENCE_BUCKET})
);

// スキル起動時
const LaunchRequestHandler = {
    canHandle(handlerInput) {
        return handlerInput.requestEnvelope.request.type === &#39;LaunchRequest&#39;;
    },
    handle(handlerInput) {
        const speechText = &#39;メモを保存する場合は「メモをセーブ」。メモを聞く場合は「メモをロード」と言ってください。&#39;;
        return handlerInput.responseBuilder
            .speak(speechText)
            .reprompt(speechText)
            .getResponse();
    }
};

// メモを保存or読み取り判別
const MainIntentHandler = {
    canHandle(handlerInput) {
        return handlerInput.requestEnvelope.request.type === &#39;IntentRequest&#39;
            &amp;&amp; handlerInput.requestEnvelope.request.intent.name === &#39;MainIntent&#39;
            &amp;&amp; handlerInput.requestEnvelope.request.dialogState === &#39;STARTED&#39;;
    },
    async handle(handlerInput) {
        const intent = handlerInput.requestEnvelope.request.intent;
        const memoSlot = intent.slots.stat;
        var modeVal = &#39;&#39;;
        
        if (memoSlot.value !== null) {
            if (memoSlot.resolutions[&#34;resolutionsPerAuthority&#34;][0][&#34;status&#34;][&#34;code&#34;] === &#39;ER_SUCCESS_MATCH&#39;) {
                modeVal = memoSlot.resolutions[&#34;resolutionsPerAuthority&#34;][0][&#34;values&#34;][0][&#34;value&#34;][&#34;name&#34;];
                
                if (modeVal === &#39;save&#39;) {
                    // メモする内容を聞きに行く
                    return handlerInput.responseBuilder.addDelegateDirective().getResponse();
                } else {
                    // S3から保存しているメモを取得
                    const attributesManager = handlerInput.attributesManager;
                    const s3Attributes = await attributesManager.getPersistentAttributes() || {};
                    const items = s3Attributes.hasOwnProperty(&#39;memoList&#39;)? s3Attributes.memoList : [];
                    var speechText = &#39;&#39;;
                    var memoData = &#39;&#39;;
                    
                    if (items.length &gt; 0) {
                        items.forEach(function( value ) {
                             memoData += `「${value.memo}」`;
                        });
                        speechText = `保存されているメモは${items.length}つあります。${memoData}です。`;    
                    }
                    return handlerInput.responseBuilder
                        .speak(speechText)
                        .reprompt(speechText)
                        .getResponse();
                }
            }
        } 
        
    }
};

// メモする言葉を取得完了
const MemoCompletedHandler = {
    canHandle(handlerInput) {
        return handlerInput.requestEnvelope.request.type === &#39;IntentRequest&#39;
            &amp;&amp; handlerInput.requestEnvelope.request.intent.name === &#39;MainIntent&#39;
            &amp;&amp; handlerInput.requestEnvelope.request.dialogState === &#39;IN_PROGRESS&#39;;
    },
    async handle(handlerInput) {
        const intent = handlerInput.requestEnvelope.request.intent;
        const memoVal = intent.slots.any.value;
        const speechText = `「${memoVal}」とメモしたよ`;
        const uuid = getUniqueStr();
        const attributesManager = handlerInput.attributesManager;
        const s3Attributes = await attributesManager.getPersistentAttributes() || {};
        const memoList = s3Attributes.hasOwnProperty(&#39;memoList&#39;)? s3Attributes.memoList : [];
        
        let memoData = {
            &#34;uuid&#34;: uuid,
            &#34;memo&#34;: memoVal
        };
        memoList.push(memoData);
        
        const sendData = {
            &#34;memoList&#34;: memoList
        }
        attributesManager.setPersistentAttributes(sendData);
        await attributesManager.savePersistentAttributes();
    
        return handlerInput.responseBuilder
            .speak(speechText)
            .reprompt(speechText)
            .getResponse();
        
    }
};

// UUID作成
function getUniqueStr(myStrong){
    var strong = 1000;
    if (myStrong) strong = myStrong;
    return new Date().getTime().toString(16)  + Math.floor(strong*Math.random()).toString(16);
}

// ヘルプ
const HelpIntentHandler = {
    canHandle(handlerInput) {
        return handlerInput.requestEnvelope.request.type === &#39;IntentRequest&#39;
            &amp;&amp; handlerInput.requestEnvelope.request.intent.name === &#39;AMAZON.HelpIntent&#39;;
    },
    handle(handlerInput) {
        const speechText = &#39;メモを保存する場合は「メモをセーブ」。メモを聞く場合は「メモをロード」と言ってください。それではどうぞ！&#39;;

        return handlerInput.responseBuilder
            .speak(speechText)
            .reprompt(speechText)
            .getResponse();
    }
};

// キャンセルor終了と発話された
const CancelAndStopIntentHandler = {
    canHandle(handlerInput) {
        return handlerInput.requestEnvelope.request.type === &#39;IntentRequest&#39;
            &amp;&amp; (handlerInput.requestEnvelope.request.intent.name === &#39;AMAZON.CancelIntent&#39;
                || handlerInput.requestEnvelope.request.intent.name === &#39;AMAZON.StopIntent&#39;);
    },
    handle(handlerInput) {
        const speechText = &#39;バイバイ！またね！&#39;;
        return handlerInput.responseBuilder
            .speak(speechText)
            .getResponse();
    }
};

// セッション切れ
const SessionEndedRequestHandler = {
    canHandle(handlerInput) {
        return handlerInput.requestEnvelope.request.type === &#39;SessionEndedRequest&#39;;
    },
    handle(handlerInput) {
        // Any cleanup logic goes here.
        return handlerInput.responseBuilder.getResponse();
    }
};

// エラー時
const ErrorHandler = {
    canHandle() {
        return true;
    },
    handle(handlerInput, error) {
        console.log(`~~~~ Error handled: ${error.message}`);
        const speechText = `不明なエラーが出ました`;

        return handlerInput.responseBuilder
            .speak(speechText)
            .reprompt(speechText)
            .getResponse();
    }
};

// 各種Handlerを登録する
exports.handler = skillBuilder
    .addRequestHandlers(
        LaunchRequestHandler,
        HelpIntentHandler,
        MainIntentHandler,
        MemoCompletedHandler,
        CancelAndStopIntentHandler,
        SessionEndedRequestHandler)
    .addErrorHandlers(
        ErrorHandler)
    .lambda();

</code></pre>
<h2>3-3. スキルを実行しよう！</h2>
<p class="image-container">デプロイが終わったらテストタブをクリックして、スキルをテストしてみましょう。</p>
<p class="image-container">「開発中」に切り替えてから「メモスキルをひらいて」と入力します。</p>
<p class="image-container"><img alt="s117" src="img/5df746283e19ba42.png"></p>
<h2>3-4. S3にあるファイルを確認しよう！</h2>
<p class="image-container">コードエディタの左下にある<code>Media storage: S3 [0.0/5GB]</code>というリンクをクリックします。</p>
<p class="image-container"><img alt="s118" src="img/8c5325fc2e25fe4.png"></p>
<p class="image-container">するとAWSのS3ページが開きます。そこにメモしたファイルが保存されているので、スキルを再起動してもメモをロードできるようになっています。</p>
<p class="image-container"><img alt="s119" src="img/f4ff7407ad560ec4.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="APL対応しよう！" duration="7">
        <h2>4-1. APLファイルを作成しよう！</h2>
<p class="image-container">APLの画面レイアウトを作成するために、ファイルを新規で作成します。<br><br>Alexa-hostedを使えば、簡単にファイルを作成することができます。</p>
<p class="image-container"><code>コードエディタ</code>タブをクリックします。<code>lambda</code>フォルダを選択して、左上にある新規作成アイコンをクリックします。</p>
<p class="image-container"><img alt="s120" src="img/48c53533f57833fb.png"></p>
<p class="image-container"><code>apl_memolist.json</code>という名前でファイルを作成しましょう。［Create File］ボタンをクリックします。</p>
<p class="image-container"><img alt="s121" src="img/a190bd77567c6459.png"></p>
<p class="image-container">入力する内容はこちらです。</p>
<p><a href="https://raw.githubusercontent.com/gaomar/apl_handson_190323/master/files/apl_memolist.json" target="_blank">https://raw.githubusercontent.com/gaomar/apl_handson_190323/master/files/apl_memolist.json</a></p>
<pre><code>{
    &#34;type&#34;: &#34;APL&#34;,
    &#34;version&#34;: &#34;1.0&#34;,
    &#34;theme&#34;: &#34;dark&#34;,
    &#34;import&#34;: [
        {
            &#34;name&#34;: &#34;alexa-layouts&#34;,
            &#34;version&#34;: &#34;1.0.0&#34;
        }
    ],
    &#34;resources&#34;: [],
    &#34;styles&#34;: {},
    &#34;layouts&#34;: {
        &#34;MemoList&#34;: {
            &#34;parameters&#34;: [
                &#34;listData&#34;
            ],
            &#34;item&#34;: {
                &#34;type&#34;: &#34;Container&#34;,
                &#34;width&#34;: &#34;100vw&#34;,
                &#34;height&#34;: &#34;100vh&#34;,
                &#34;direction&#34;: &#34;column&#34;,
                &#34;item&#34;: {
                    &#34;type&#34;: &#34;Sequence&#34;,
                    &#34;grow&#34;: 1,
                    &#34;height&#34;: &#34;80vh&#34;,
                    &#34;scrollDirection&#34;: &#34;vertical&#34;,
                    &#34;paddingLeft&#34;: &#34;@marginLeft&#34;,
                    &#34;paddingRight&#34;: &#34;@marginRight&#34;,
                    &#34;data&#34;: &#34;${listData}&#34;,
                    &#34;numbered&#34;: true,
                    &#34;items&#34;: {
                        &#34;type&#34;: &#34;VerticalListItem&#34;,
                        &#34;primaryText&#34;: &#34;${data.memo}&#34;
                    }
                }
            }
        },
        &#34;VerticalListItem&#34;: {
            &#34;parameters&#34;: [
                &#34;primaryText&#34;
            ],
            &#34;item&#34;: {
                &#34;type&#34;: &#34;Container&#34;,
                &#34;direction&#34;: &#34;row&#34;,
                &#34;height&#34;: 125,
                &#34;width&#34;: &#34;100%&#34;,
                &#34;alignItems&#34;: &#34;center&#34;,
                &#34;separator&#34;: true,
                &#34;items&#34;: [
                    {
                        &#34;type&#34;: &#34;Text&#34;,
                        &#34;text&#34;: &#34;${ordinal}&#34;,
                        &#34;color&#34;: &#34;white&#34;,
                        &#34;spacing&#34;: &#34;5dp&#34;
                    },
                    {
                        &#34;type&#34;: &#34;Text&#34;,
                        &#34;text&#34;: &#34;${primaryText}&#34;,
                        &#34;color&#34;: &#34;white&#34;,
                        &#34;width&#34;: &#34;100vw&#34;,
                        &#34;spacing&#34;: &#34;5vw&#34;
                    }
                ]
            }
        }
    },
    &#34;mainTemplate&#34;: {
        &#34;parameters&#34;: [
            &#34;payload&#34;
        ],
        &#34;items&#34;: [
            {
                &#34;type&#34;: &#34;MemoList&#34;,
                &#34;listData&#34;: &#34;${payload.MemoSkill.memoList}&#34;
            }
        ]
    }
}
</code></pre>
<p class="image-container">ファイルを保存し忘れないようにしましょう。</p>
<p class="image-container"><img alt="s122" src="img/50bc29da340f99f7.png"></p>
<h2>4-2. APLを適用しよう！</h2>
<p class="image-container">先程作成したjsonファイルをプログラムに適用します。<br><br>index.jsファイルを書き換えます。</p>
<p class="image-container">61行目にある<code>addDirective</code>のdocumentにjsonファイルを指定します。data部分にS3から取得したデータ値を設定します。</p>
<p><a href="https://raw.githubusercontent.com/gaomar/apl_handson_190323/master/files/step2.js" target="_blank">https://raw.githubusercontent.com/gaomar/apl_handson_190323/master/files/step2.js</a></p>
<pre><code>const Alexa = require(&#39;ask-sdk-core&#39;);

// 1. ask persistence adapterの読み込み
const persistenceAdapter = require(&#39;ask-sdk-s3-persistence-adapter&#39;);

// 2. スキルビルダーをアダプターを使用して初期化
const skillBuilder = Alexa.SkillBuilders.custom().withPersistenceAdapter(
    new persistenceAdapter.S3PersistenceAdapter({bucketName:process.env.S3_PERSISTENCE_BUCKET})
);

// スキル起動時
const LaunchRequestHandler = {
    canHandle(handlerInput) {
        return handlerInput.requestEnvelope.request.type === &#39;LaunchRequest&#39;;
    },
    handle(handlerInput) {
        const speechText = &#39;メモを保存する場合は「メモをセーブ」。メモを聞く場合は「メモをロード」と言ってください。&#39;;
        return handlerInput.responseBuilder
            .speak(speechText)
            .reprompt(speechText)
            .getResponse();
    }
};

// メモを保存or読み取り判別
const MainIntentHandler = {
    canHandle(handlerInput) {
        return handlerInput.requestEnvelope.request.type === &#39;IntentRequest&#39;
            &amp;&amp; handlerInput.requestEnvelope.request.intent.name === &#39;MainIntent&#39;
            &amp;&amp; handlerInput.requestEnvelope.request.dialogState === &#39;STARTED&#39;;
    },
    async handle(handlerInput) {
        const intent = handlerInput.requestEnvelope.request.intent;
        const memoSlot = intent.slots.stat;
        var modeVal = &#39;&#39;;
        
        if (memoSlot.value !== null) {
            if (memoSlot.resolutions[&#34;resolutionsPerAuthority&#34;][0][&#34;status&#34;][&#34;code&#34;] === &#39;ER_SUCCESS_MATCH&#39;) {
                modeVal = memoSlot.resolutions[&#34;resolutionsPerAuthority&#34;][0][&#34;values&#34;][0][&#34;value&#34;][&#34;name&#34;];
                
                if (modeVal === &#39;save&#39;) {
                    // メモする内容を聞きに行く
                    return handlerInput.responseBuilder.addDelegateDirective().getResponse();
                } else {
                    // S3から保存しているメモを取得
                    const attributesManager = handlerInput.attributesManager;
                    const s3Attributes = await attributesManager.getPersistentAttributes() || {};
                    const items = s3Attributes.hasOwnProperty(&#39;memoList&#39;)? s3Attributes.memoList : [];
                    var speechText = &#39;&#39;;
                    var memoData = &#39;&#39;;
                    
                    if (items.length &gt; 0) {
                        items.forEach(function( value ) {
                             memoData += `「${value.memo}」`;
                        });
                        speechText = `保存されているメモは${items.length}つあります。${memoData}です。`;    
                    }
                    return handlerInput.responseBuilder
                        .speak(speechText)
                        .reprompt(speechText)
                        .addDirective({
                            type : &#39;Alexa.Presentation.APL.RenderDocument&#39;,
                            version: &#39;1.0&#39;,
                            token: &#34;token&#34;,
                            document: require(&#39;./apl_memolist.json&#39;),
                            datasources: {
                                &#34;MemoSkill&#34;: {
                                    &#34;memoList&#34;: items
                                }
                            }
                        })            
                        .getResponse();
                }
            }
        } 
        
    }
};

// メモする言葉を取得完了
const MemoCompletedHandler = {
    canHandle(handlerInput) {
        return handlerInput.requestEnvelope.request.type === &#39;IntentRequest&#39;
            &amp;&amp; handlerInput.requestEnvelope.request.intent.name === &#39;MainIntent&#39;
            &amp;&amp; handlerInput.requestEnvelope.request.dialogState === &#39;IN_PROGRESS&#39;;
    },
    async handle(handlerInput) {
        const intent = handlerInput.requestEnvelope.request.intent;
        const memoVal = intent.slots.any.value;
        const speechText = `「${memoVal}」とメモしたよ`;
        const uuid = getUniqueStr();
        const attributesManager = handlerInput.attributesManager;
        const s3Attributes = await attributesManager.getPersistentAttributes() || {};
        const memoList = s3Attributes.hasOwnProperty(&#39;memoList&#39;)? s3Attributes.memoList : [];
        
        let memoData = {
            &#34;uuid&#34;: uuid,
            &#34;memo&#34;: memoVal
        };
        memoList.push(memoData);
        
        const sendData = {
            &#34;memoList&#34;: memoList
        }
        attributesManager.setPersistentAttributes(sendData);
        await attributesManager.savePersistentAttributes();
    
        return handlerInput.responseBuilder
            .speak(speechText)
            .reprompt(speechText)
            .getResponse();
        
    }
};

// UUID作成
function getUniqueStr(myStrong){
    var strong = 1000;
    if (myStrong) strong = myStrong;
    return new Date().getTime().toString(16)  + Math.floor(strong*Math.random()).toString(16);
}

// ヘルプ
const HelpIntentHandler = {
    canHandle(handlerInput) {
        return handlerInput.requestEnvelope.request.type === &#39;IntentRequest&#39;
            &amp;&amp; handlerInput.requestEnvelope.request.intent.name === &#39;AMAZON.HelpIntent&#39;;
    },
    handle(handlerInput) {
        const speechText = &#39;メモを保存する場合は「メモをセーブ」。メモを聞く場合は「メモをロード」と言ってください。それではどうぞ！&#39;;

        return handlerInput.responseBuilder
            .speak(speechText)
            .reprompt(speechText)
            .getResponse();
    }
};

// キャンセルor終了と発話された
const CancelAndStopIntentHandler = {
    canHandle(handlerInput) {
        return handlerInput.requestEnvelope.request.type === &#39;IntentRequest&#39;
            &amp;&amp; (handlerInput.requestEnvelope.request.intent.name === &#39;AMAZON.CancelIntent&#39;
                || handlerInput.requestEnvelope.request.intent.name === &#39;AMAZON.StopIntent&#39;);
    },
    handle(handlerInput) {
        const speechText = &#39;バイバイ！またね！&#39;;
        return handlerInput.responseBuilder
            .speak(speechText)
            .getResponse();
    }
};

// セッション切れ
const SessionEndedRequestHandler = {
    canHandle(handlerInput) {
        return handlerInput.requestEnvelope.request.type === &#39;SessionEndedRequest&#39;;
    },
    handle(handlerInput) {
        // Any cleanup logic goes here.
        return handlerInput.responseBuilder.getResponse();
    }
};

// エラー時
const ErrorHandler = {
    canHandle() {
        return true;
    },
    handle(handlerInput, error) {
        console.log(`~~~~ Error handled: ${error.message}`);
        const speechText = `不明なエラーが出ました`;

        return handlerInput.responseBuilder
            .speak(speechText)
            .reprompt(speechText)
            .getResponse();
    }
};

// 各種Handlerを登録する
exports.handler = skillBuilder
    .addRequestHandlers(
        LaunchRequestHandler,
        HelpIntentHandler,
        MainIntentHandler,
        MemoCompletedHandler,
        CancelAndStopIntentHandler,
        SessionEndedRequestHandler)
    .addErrorHandlers(
        ErrorHandler)
    .lambda();

</code></pre>
<p class="image-container">［Save］と［Deploy］ボタンを押し忘れないようにしましょう。</p>
<p class="image-container"><img alt="s123" src="img/cec20204647f68fa.png"></p>
<h2>4-3. シミュレーターで確認しよう！</h2>
<p class="image-container">APL対応できたかをシミュレーターで確認しましょう。テストタブをクリックして、スキルを起動します。</p>
<p class="image-container"><img alt="s124" src="img/baa23aa03ec49159.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="タッチに反応させよう！" duration="6">
        <p class="image-container">画面タッチして反応するようにしましょう。今回はスキル初回起動時にSAVEボタンとLOADボタンを設置して、押されたボタンに応じて処理を変更します。</p>
<h2>5-1. トップ画面を作る</h2>
<p class="image-container">スキル起動直後に表示するトップ画面です。<br><br>単純にSAVEとLOADボタンが設置してあるだけです。</p>
<p class="image-container">では、APLファイルを新規作成します。コードエディタタブをクリックして、新規ファイル作成します。</p>
<p class="image-container"><img alt="s130" src="img/fa42407b849444c6.png"></p>
<p class="image-container"><code>apl_top.json</code>でファイルを作成します。</p>
<p class="image-container"><img alt="s131" src="img/1bef8145e7966e4d.png"></p>
<p class="image-container">apl_top.jsonの中身は下記をコピペしてください。</p>
<p><a href="https://raw.githubusercontent.com/gaomar/apl_handson_190323/master/files/apl_top.json" target="_blank">https://raw.githubusercontent.com/gaomar/apl_handson_190323/master/files/apl_top.json</a></p>
<pre><code>{
    &#34;type&#34;: &#34;APL&#34;,
    &#34;version&#34;: &#34;1.0&#34;,
    &#34;theme&#34;: &#34;dark&#34;,
    &#34;import&#34;: [],
    &#34;resources&#34;: [],
    &#34;styles&#34;: {},
    &#34;layouts&#34;: {},
    &#34;mainTemplate&#34;: {
        &#34;parameters&#34;: [
            &#34;payload&#34;
        ],
        &#34;items&#34;: [
            {
                &#34;type&#34;: &#34;Container&#34;,
                &#34;direction&#34;: &#34;column&#34;,
                &#34;item&#34;: [
                    {
                        &#34;type&#34;: &#34;Text&#34;,
                        &#34;textAlign&#34;: &#34;center&#34;,
                        &#34;paddingTop&#34;: &#34;15vh&#34;,
                        &#34;text&#34;: &#34;メニュー選択&#34;
                    },
                    {
                        &#34;type&#34;: &#34;Container&#34;,
                        &#34;direction&#34;: &#34;row&#34;,
                        &#34;alignItems&#34;: &#34;center&#34;,
                        &#34;justifyContent&#34;: &#34;center&#34;,
                        &#34;width&#34;: &#34;100vw&#34;,
                        &#34;height&#34;: &#34;50vh&#34;,
                        &#34;paddingTop&#34;: &#34;10vh&#34;,
                        &#34;items&#34;: [
                            {
                                &#34;type&#34;: &#34;Container&#34;,
                                &#34;paddingRight&#34;: &#34;5vw&#34;,
                                &#34;item&#34;: [
                                    {
                                        &#34;type&#34;: &#34;TouchWrapper&#34;,
                                        &#34;onPress&#34;: {
                                            &#34;type&#34;: &#34;SendEvent&#34;,
                                            &#34;arguments&#34;: [
                                                &#34;save&#34;
                                            ]
                                        },
                                        &#34;item&#34;: [
                                            {
                                                &#34;type&#34;: &#34;Frame&#34;,
                                                &#34;borderRadius&#34;: 10,
                                                &#34;backgroundColor&#34;: &#34;blue&#34;,
                                                &#34;item&#34;: [
                                                    {
                                                        &#34;type&#34;: &#34;Text&#34;,
                                                        &#34;text&#34;: &#34;SAVE&#34;,
                                                        &#34;width&#34;: &#34;30vw&#34;,
                                                        &#34;height&#34;: &#34;20vh&#34;,
                                                        &#34;textAlign&#34;: &#34;center&#34;,
                                                        &#34;textAlignVertical&#34;: &#34;center&#34;
                                                    }
                                                ]
                                            }
                                        ]
                                    }
                                ]
                            },
                            {
                                &#34;type&#34;: &#34;Container&#34;,
                                &#34;paddingLeft&#34;: &#34;5vw&#34;,
                                &#34;item&#34;: [
                                    {
                                        &#34;type&#34;: &#34;TouchWrapper&#34;,
                                        &#34;onPress&#34;: {
                                            &#34;type&#34;: &#34;SendEvent&#34;,
                                            &#34;arguments&#34;: [
                                                &#34;load&#34;
                                            ]
                                        },
                                        &#34;item&#34;: [
                                            {
                                                &#34;type&#34;: &#34;Frame&#34;,
                                                &#34;borderRadius&#34;: 10,
                                                &#34;backgroundColor&#34;: &#34;green&#34;,
                                                &#34;item&#34;: [
                                                    {
                                                        &#34;type&#34;: &#34;Text&#34;,
                                                        &#34;text&#34;: &#34;LOAD&#34;,
                                                        &#34;width&#34;: &#34;30vw&#34;,
                                                        &#34;height&#34;: &#34;20vh&#34;,
                                                        &#34;textAlign&#34;: &#34;center&#34;,
                                                        &#34;textAlignVertical&#34;: &#34;center&#34;
                                                    }
                                                ]
                                            }
                                        ]
                                    }
                                ]
                            }
                        ]
                    },
                    {
                        &#34;type&#34;: &#34;Text&#34;,
                        &#34;textAlign&#34;: &#34;center&#34;,
                        &#34;fontSize&#34;: &#34;4vw&#34;,
                        &#34;text&#34;: &#34;${payload.MemoSkill.hint}&#34;
                    }
                ]
            }
        ]
    }
}
</code></pre>
<p class="image-container">APLオーサリングツールで見るとこのような画面になります。</p>
<p class="image-container"><img alt="s132" src="img/207b06a912114d0f.png"></p>
<h2>5-2. 使い手にわかりやすくする</h2>
<p class="image-container">今のままだとボタン押したあとに、SAVEとLOADボタンが表示されたままになります。<br><br>それを防ぐために画面を切り替えて、次に行ってもらう事を画面上に表示させます。</p>
<p class="image-container">新規ファイル作成してください。</p>
<p class="image-container"><img alt="s133" src="img/c961d5bc20bad93e.png"></p>
<p class="image-container"><code>apl_text.json</code>ファイルを作成します。</p>
<p class="image-container"><img alt="s134" src="img/46469b970d4f6ad3.png"></p>
<p class="image-container">下記をコピペしてください。</p>
<p><a href="https://raw.githubusercontent.com/gaomar/apl_handson_190323/master/files/apl_text.json" target="_blank">https://raw.githubusercontent.com/gaomar/apl_handson_190323/master/files/apl_text.json</a></p>
<pre><code>{
    &#34;type&#34;: &#34;APL&#34;,
    &#34;version&#34;: &#34;1.0&#34;,
    &#34;theme&#34;: &#34;dark&#34;,
    &#34;import&#34;: [],
    &#34;resources&#34;: [],
    &#34;styles&#34;: {},
    &#34;layouts&#34;: {},
    &#34;mainTemplate&#34;: {
        &#34;parameters&#34;: [
            &#34;payload&#34;
        ],
        &#34;items&#34;: [
            {
                &#34;type&#34;: &#34;Container&#34;,
                &#34;width&#34;: &#34;100vw&#34;,
                &#34;height&#34;: &#34;100vh&#34;,
                &#34;alignItems&#34;: &#34;center&#34;,
                &#34;direction&#34;: &#34;column&#34;,
                &#34;justifyContent&#34;: &#34;center&#34;,
                &#34;item&#34;: [
                    {
                        &#34;type&#34;: &#34;Text&#34;,
                        &#34;width&#34;: &#34;90vw&#34;,
                        &#34;textAlign&#34;: &#34;center&#34;,
                        &#34;fontSize&#34;: &#34;10vw&#34;,
                        &#34;text&#34;: &#34;${payload.MemoSkill.word}&#34;
                    }
                ]
            }
        ]
    }
}
</code></pre>
<p class="image-container">APLオーサリングツールで見るとこのような画面になります。<br><code>${payload.MemoSkill.word}</code>部分はプログラムで可変できるようにしています。</p>
<p class="image-container"><img alt="s135" src="img/faa395f59c80c9f1.png"></p>
<h2>5-3. APLを適用する</h2>
<p class="image-container">今まで作成したAPLを適用します。step3.jsの中身をコピペしてください。</p>
<p><a href="https://raw.githubusercontent.com/gaomar/apl_handson_190323/master/files/step3.js" target="_blank">https://raw.githubusercontent.com/gaomar/apl_handson_190323/master/files/step3.js</a></p>
<pre><code>const Alexa = require(&#39;ask-sdk-core&#39;);

// 1. ask persistence adapterの読み込み
const persistenceAdapter = require(&#39;ask-sdk-s3-persistence-adapter&#39;);

// 2. スキルビルダーをアダプターを使用して初期化
const skillBuilder = Alexa.SkillBuilders.custom().withPersistenceAdapter(
    new persistenceAdapter.S3PersistenceAdapter({bucketName:process.env.S3_PERSISTENCE_BUCKET})
);

// スキル起動時
const LaunchRequestHandler = {
    canHandle(handlerInput) {
        return handlerInput.requestEnvelope.request.type === &#39;LaunchRequest&#39;;
    },
    handle(handlerInput) {
        const speechText = &#39;メニューをタップしてください。&#39;;
        return handlerInput.responseBuilder
            .speak(speechText)
            .addDirective({
                type : &#39;Alexa.Presentation.APL.RenderDocument&#39;,
                version: &#39;1.0&#39;,
                token: &#34;token&#34;,
                document: require(&#39;./apl_top.json&#39;),
                datasources: {
                    &#34;MemoSkill&#34;: {
                        &#34;hint&#34;: &#34;メニューをタップしてください&#34;
                    }
                }
            })            
            .getResponse();
    }
};

// 画面タッチ処理
// シミュレーターではonPressが反応し、実機ではPressが反応するため2つ書いておく
const TouchEventHandler = {
    canHandle(handlerInput) {
    return ((handlerInput.requestEnvelope.request.type === &#39;Alexa.Presentation.APL.UserEvent&#39; &amp;&amp;
        (handlerInput.requestEnvelope.request.source.handler === &#39;Press&#39; || 
        handlerInput.requestEnvelope.request.source.handler === &#39;onPress&#39;)));
    },
    async handle(handlerInput) {
        // TcouhWrapperのargumentsで指定したパラメータを取得する
        const choice = handlerInput.requestEnvelope.request.arguments[0];

        if (choice === &#39;save&#39;) {
            return handlerInput.responseBuilder
                .speak(&#39;メモする言葉を言ってください。&#39;)
                .addDirective({
                    type : &#39;Alexa.Presentation.APL.RenderDocument&#39;,
                    version: &#39;1.0&#39;,
                    token: &#34;token&#34;,
                    document: require(&#39;./apl_text.json&#39;),
                    datasources: {
                        &#34;MemoSkill&#34;: {
                            &#34;word&#34;: &#34;「アレクサ、○○とメモして」と言ってください。&#34; 
                        }
                    }
                })            
                .getResponse();

            
        }
            
        // S3から保存しているメモを取得
        const attributesManager = handlerInput.attributesManager;
        const s3Attributes = await attributesManager.getPersistentAttributes() || {};
        const items = s3Attributes.hasOwnProperty(&#39;memoList&#39;)? s3Attributes.memoList : [];
        var speechText = &#39;&#39;;
        var memoData = &#39;&#39;;
        
        if (items.length &gt; 0) {
            items.forEach(function( value ) {
                 memoData += `「${value.memo}」`;
            });
            speechText = `保存されているメモは${items.length}つあります。${memoData}です。`;    
        }
        return handlerInput.responseBuilder
            .speak(speechText)
            .reprompt(speechText)
            .addDirective({
                type : &#39;Alexa.Presentation.APL.RenderDocument&#39;,
                version: &#39;1.0&#39;,
                token: &#34;token&#34;,
                document: require(&#39;./apl_memolist.json&#39;),
                datasources: {
                    &#34;MemoSkill&#34;: {
                        &#34;memoList&#34;: items
                    }
                }
            })            
            .getResponse();
    }
};

// メモを保存or読み取り判別
const MainIntentHandler = {
    canHandle(handlerInput) {
        return handlerInput.requestEnvelope.request.type === &#39;IntentRequest&#39;
            &amp;&amp; handlerInput.requestEnvelope.request.intent.name === &#39;MainIntent&#39;
            &amp;&amp; handlerInput.requestEnvelope.request.dialogState === &#39;STARTED&#39;;
    },
    async handle(handlerInput) {
        const intent = handlerInput.requestEnvelope.request.intent;
        const memoSlot = intent.slots.stat;
        var modeVal = &#39;&#39;;
        
        if (memoSlot.value !== null) {
            if (memoSlot.resolutions[&#34;resolutionsPerAuthority&#34;][0][&#34;status&#34;][&#34;code&#34;] === &#39;ER_SUCCESS_MATCH&#39;) {
                modeVal = memoSlot.resolutions[&#34;resolutionsPerAuthority&#34;][0][&#34;values&#34;][0][&#34;value&#34;][&#34;name&#34;];
                
                if (modeVal === &#39;save&#39;) {
                    // メモする内容を聞きに行く
                    return handlerInput.responseBuilder.addDelegateDirective().getResponse();
                } else {
                    // S3から保存しているメモを取得
                    const attributesManager = handlerInput.attributesManager;
                    const s3Attributes = await attributesManager.getPersistentAttributes() || {};
                    const items = s3Attributes.hasOwnProperty(&#39;memoList&#39;)? s3Attributes.memoList : [];
                    var speechText = &#39;&#39;;
                    var memoData = &#39;&#39;;
                    
                    if (items.length &gt; 0) {
                        items.forEach(function( value ) {
                             memoData += `「${value.memo}」`;
                        });
                        speechText = `保存されているメモは${items.length}つあります。${memoData}です。`;    
                    }
                    return handlerInput.responseBuilder
                        .speak(speechText)
                        .reprompt(speechText)
                        .addDirective({
                            type : &#39;Alexa.Presentation.APL.RenderDocument&#39;,
                            version: &#39;1.0&#39;,
                            token: &#34;token&#34;,
                            document: require(&#39;./apl_memolist.json&#39;),
                            datasources: {
                                &#34;MemoSkill&#34;: {
                                    &#34;memoList&#34;: items
                                }
                            }
                        })            
                        .getResponse();
                }
            }
        } 
        
    }
};

// メモする言葉を取得完了
const MemoCompletedHandler = {
    canHandle(handlerInput) {
        return (handlerInput.requestEnvelope.request.type === &#39;IntentRequest&#39;
            &amp;&amp; handlerInput.requestEnvelope.request.intent.name === &#39;MainIntent&#39;
            &amp;&amp; handlerInput.requestEnvelope.request.dialogState === &#39;IN_PROGRESS&#39;) ||
            (handlerInput.requestEnvelope.request.type === &#39;IntentRequest&#39;
            &amp;&amp; handlerInput.requestEnvelope.request.intent.name === &#39;SaveIntent&#39;);
    },
    async handle(handlerInput) {
        const intent = handlerInput.requestEnvelope.request.intent;
        const memoVal = intent.slots.any.value;
        const speechText = `「${memoVal}」とメモしたよ`;
        const uuid = getUniqueStr();
        const attributesManager = handlerInput.attributesManager;
        const s3Attributes = await attributesManager.getPersistentAttributes() || {};
        const memoList = s3Attributes.hasOwnProperty(&#39;memoList&#39;)? s3Attributes.memoList : [];
        
        let memoData = {
            &#34;uuid&#34;: uuid,
            &#34;memo&#34;: memoVal
        };
        memoList.push(memoData);
        
        const sendData = {
            &#34;memoList&#34;: memoList
        }
        attributesManager.setPersistentAttributes(sendData);
        await attributesManager.savePersistentAttributes();
    
        return handlerInput.responseBuilder
            .speak(speechText)
            .addDirective({
                type : &#39;Alexa.Presentation.APL.RenderDocument&#39;,
                version: &#39;1.0&#39;,
                token: &#34;token&#34;,
                document: require(&#39;./apl_top.json&#39;),
                datasources: {
                    &#34;MemoSkill&#34;: {
                        &#34;hint&#34;: speechText
                    }
                }
            })            
            .getResponse();
        
    }
};

// UUID作成
function getUniqueStr(myStrong){
    var strong = 1000;
    if (myStrong) strong = myStrong;
    return new Date().getTime().toString(16)  + Math.floor(strong*Math.random()).toString(16);
}

// ヘルプ
const HelpIntentHandler = {
    canHandle(handlerInput) {
        return handlerInput.requestEnvelope.request.type === &#39;IntentRequest&#39;
            &amp;&amp; handlerInput.requestEnvelope.request.intent.name === &#39;AMAZON.HelpIntent&#39;;
    },
    handle(handlerInput) {
        const speechText = &#39;メモを保存する場合は「メモをセーブ」。メモを聞く場合は「メモをロード」と言ってください。それではどうぞ！&#39;;

        return handlerInput.responseBuilder
            .speak(speechText)
            .reprompt(speechText)
            .getResponse();
    }
};

// キャンセルor終了と発話された
const CancelAndStopIntentHandler = {
    canHandle(handlerInput) {
        return handlerInput.requestEnvelope.request.type === &#39;IntentRequest&#39;
            &amp;&amp; (handlerInput.requestEnvelope.request.intent.name === &#39;AMAZON.CancelIntent&#39;
                || handlerInput.requestEnvelope.request.intent.name === &#39;AMAZON.StopIntent&#39;);
    },
    handle(handlerInput) {
        const speechText = &#39;バイバイ！またね！&#39;;
        return handlerInput.responseBuilder
            .speak(speechText)
            .getResponse();
    }
};

// セッション切れ
const SessionEndedRequestHandler = {
    canHandle(handlerInput) {
        return handlerInput.requestEnvelope.request.type === &#39;SessionEndedRequest&#39;;
    },
    handle(handlerInput) {
        // Any cleanup logic goes here.
        return handlerInput.responseBuilder.getResponse();
    }
};

// エラー時
const ErrorHandler = {
    canHandle() {
        return true;
    },
    handle(handlerInput, error) {
        console.log(`~~~~ Error handled: ${error.message}`);
        const speechText = `不明なエラーが出ました`;

        return handlerInput.responseBuilder
            .speak(speechText)
            .reprompt(speechText)
            .getResponse();
    }
};

// 各種Handlerを登録する
exports.handler = skillBuilder
    .addRequestHandlers(
        LaunchRequestHandler,
        HelpIntentHandler,
        MainIntentHandler,
        MemoCompletedHandler,
        TouchEventHandler,
        CancelAndStopIntentHandler,
        SessionEndedRequestHandler)
    .addErrorHandlers(
        ErrorHandler)
    .lambda();

</code></pre>
<h2>5-4. メモ保存用Intentを作成する</h2>
<p class="image-container">APLからDialogモードを制御することができません。<br><br>専用のIntentを作成して、そのIntentを経由して実現します。</p>
<p class="image-container">ビルドタブをクリックして、インテント側にある［追加］ボタンをクリックします。</p>
<p class="image-container"><img alt="s140" src="img/7f278074d9235940.png"></p>
<p class="image-container">自由テキストを手に入れるために変数名<code>any</code>を指定して、<code>AMAZON.SearchQuery</code>を選択します。<br><br>サンプル発話に3種類ほど登録してから、［保存］［ビルド］を実行します。</p>
<p class="image-container"><img alt="s141" src="img/4dc70b5d92951558.png"></p>
<h2>5-5. シミュレーターで確認する</h2>
<p class="image-container">テストタブをクリックして、シミュレーター画面に遷移してください。<br><br>スキルを起動するとSAVEとLOADボタンが表示されるので、SAVEボタンをクリックして動作確認してみましょう。</p>
<p class="image-container"><img alt="s142" src="img/1a8527bd3b1ada8f.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="元号ジェネレーターを作ってみよう" duration="10">
        <p class="image-container">余力がある方は既にAlexaストアで公開している元号ジェネレーターを作ってみましょう。<br>このスキルは今までに使われた元号の漢字からランダムで2文字生成して背景画像と合成します。</p>
<p><a href="https://www.amazon.co.jp/gp/product/B07PF7PQXT" target="_blank">https://www.amazon.co.jp/gp/product/B07PF7PQXT</a></p>
<h2>6-1. 新規スキルを作成</h2>
<p class="image-container">新しいスキルを作成するので、［スキルの作成］ボタンをクリックします。</p>
<p class="image-container"><img alt="s150" src="img/e950a4833d4ca8f6.png"></p>
<p class="image-container">スキル名に「元号ツール」モデルは<code>カスタム</code>、ホスティング方法を<code>Alexaホスト</code>をそれぞれ選択して、右上の［スキルを作成］ボタンをクリックします。</p>
<p class="image-container"><img alt="s151" src="img/79449c22d6834e3e.png"></p>
<p class="image-container">画面が切り替わったら、左メニューにある<code>インターフェース</code>をクリックします。<br><code>Displayインターフェース</code>と<code>APL</code>をそれぞれ有効にします。<br>有効にしたら、ビルドと保存ボタンをクリックします。</p>
<p class="image-container"><img alt="s152" src="img/5251db871b18e194.png"></p>
<h2>6-2. コードを編集する</h2>
<p class="image-container"><code>コードエディタ</code>タブをクリックします。<code>index.js</code>をクリックしてコードを編集します。<br>下記URLからコードをコピペしてください。</p>
<p><a href="https://raw.githubusercontent.com/gaomar/apl_handson_190323/master/files/step4.js" target="_blank">https://raw.githubusercontent.com/gaomar/apl_handson_190323/master/files/step4.js</a></p>
<p class="image-container"><img alt="s153" src="img/db7313e52007c8d0.png"></p>
<h2>6-3. APLファイルを新規作成</h2>
<p class="image-container"><code>lambda</code>フォルダを選択して左上にある新規ファイル作成ボタンをクリックします。</p>
<p class="image-container"><img alt="s154" src="img/37ec6641ca7dfc09.png"></p>
<p class="image-container">ファイル名は<code>apl_gengo.json</code>としてください。</p>
<p class="image-container"><img alt="s155" src="img/15817f84e85dd049.png"></p>
<p class="image-container">apl_gengo.jsonファイルを編集します。下記URLからコードをコピペしてください。</p>
<p><a href="https://raw.githubusercontent.com/gaomar/apl_handson_190323/master/files/apl_gengo.json" target="_blank">https://raw.githubusercontent.com/gaomar/apl_handson_190323/master/files/apl_gengo.json</a></p>
<p class="image-container"><img alt="s156" src="img/eaca39647d6cc993.png"></p>
<h2>6-4. シミュレーターで確認する</h2>
<p class="image-container">テストタブをクリックしてシミュレーターでテストしてみましょう。<br>プルダウンメニューから<code>開発中</code>を選択します。</p>
<p class="image-container">「元号ツールをひらいて」と入力するとスキルを実行することができます。</p>
<p class="image-container"><img alt="s157" src="img/8bbe0727f0388450.png"></p>
<h2>6-5. Alexa-hostedのS3から画像を呼ぶ</h2>
<p class="image-container">Alexa-hostedにはS3も使えます。<br>コードエディタの左下にS3のリンクがあるのでクリックします。</p>
<p class="image-container"><img alt="s158" src="img/f08c88e0adafc937.png"></p>
<p class="image-container">こちらの<code>gengo.png</code>画像を一度ローカルPCにダウンロードします。</p>
<p><a href="https://github.com/gaomar/apl_handson_190323/raw/master/files/gengo.png" target="_blank">https://github.com/gaomar/apl_handson_190323/raw/master/files/gengo.png</a></p>
<p class="image-container">S3のページが表示されたら、画像をアップロードするので［アップロード］ボタンを押します。</p>
<p class="image-container"><img alt="s159" src="img/84cc01812a7cba8e.png"></p>
<p class="image-container">先程ダウンロードした<code>gengo.png</code>ファイルを指定して。アップロードボタンをクリックします。</p>
<p class="image-container"><img alt="s160" src="img/abe7f8517862f278.png"></p>
<p class="image-container">Alexa Developer Consoleに戻って、<code>apl_gengo.json</code>ファイルを編集します。<br>32行目を下記に書き換えます。保存ボタンを忘れずにクリックします。</p>
<pre><code>&#34;source&#34;: &#34;${payload.skilldata.backgroundUrl}&#34;,
</code></pre>
<p class="image-container"><img alt="s161" src="img/adc640031d3bf358.png"></p>
<p class="image-container">続いて<code>index.js</code>ファイルも書き換えます。<br>step5.jsの内容をコピペします。保存とデプロイを忘れずにしましょう！</p>
<p><a href="https://raw.githubusercontent.com/gaomar/apl_handson_190323/master/files/step5.js" target="_blank">https://raw.githubusercontent.com/gaomar/apl_handson_190323/master/files/step5.js</a></p>
<p class="image-container">2行目でutil.jsファイルを指定してS3から取得する関数を呼び出します。<br>27行目でS3に保存されているファイル名を指定して、一時アクセス可能なURLを取得します。<br>56行目でAPLに画像URLを指定します。</p>
<p class="image-container"><img alt="s162" src="img/ed2d302fcbafb703.png"></p>
<h2>6-6. シミュレーターで確認</h2>
<p class="image-container">これでスキルをテストするとS3から画像を呼び出していることが確認できると思います。</p>
<h2>6-7. まとめ</h2>
<p class="image-container">APLを使えば簡単に画面対応することができます。アイデア次第で様々なスキルを開発することができるので、どんどんAPLを使っていきましょう！</p>


      </google-codelab-step>
    
  </google-codelab>

  <script src="https://storage.googleapis.com/codelab-elements/native-shim.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/custom-elements.min.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/prettify.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/codelab-elements.js"></script>

</body>
</html>
